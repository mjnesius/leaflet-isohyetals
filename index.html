<!DOCTYPE html>
<!-- see https://turfjs.org/docs/#isobands and https://github.com/d3/d3-contour-->
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
    <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.3.2/dist/esri-leaflet.js"
  integrity="sha512-6LVib9wGnqVKIClCduEwsCub7iauLXpwrd5njR2J507m3A2a4HXJDLMiSZzjcksag3UluIfuW1KzuWVI5n/cuQ=="
  crossorigin=""></script>

  <!--  d3 contour library ==> creates a d3 global with a contours() method-->
  <script src="https://d3js.org/d3-contour.v1.min.js"></script>

  <!--  turf interpolation library ==> creates a turf global. has featureCollection helper and isobands() method-->
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
        <title>isohyetals</title>
<style>
body {
    padding: 0;
    margin: 0;
}
html, body, #mapid {
    height: 100%;
    width: 100vw;
}
.date {left: 40%;
    vertical-align: top;
    text-align: center;
    position: absolute;
    display: flex;
    align-items: center;
    z-index: 999;
    white-space: pre-wrap;
    margin-top: 10px

}

@media only screen and (max-width:800px) {
  /* For tablets: */
  .main {
    width: 80%;
    padding: 0;
  }
  .right {
    width: 100%;
  }
}
@media only screen and (max-width:500px) {
  /* For mobile phones: */
  .menu, .main, .right {
    width: 100%;
  }
}
</style>
</head>
<body class="map" id="map">
    
        <div class="date " >
           <font color="white"><b>Start Date  </b> </font>
        <input style="white-space: normal;" type="date" id="start">
        <font color="white"><b>   End Date  </b> </font>
        <input style="white-space: normal;" type="date" id="end">
        <button style="height: 22px; margin-left: 5px; text-align: center" type="button" onclick="getRainData()"> Submit
        </div>
        
    
    
    <div class="map" id="mapid">

    </div>
    
    
</body>
</html>


<script>
    var mymap = L.map('mapid').setView([30.45, -84.31], 13);

    L.esri.basemapLayer('DarkGray').addTo(mymap)

    var oneRainDataDict = {};
    var nwfwmdDataDict = {};
    const oneRainSysKey = "79cb5383-a4cb-467c-9e29-fe1ce57b6497";
    const baseOneRainURL = "http://cs-022-exchange.onerain.com:8080/OneRain/DataAPI?method=GetSensorData";

      // the list is [or_site_id, or_sensor_id]
    const oneRainGetDict = {
      "STREETS AND DRAINAGE (CITY ID# 300)": ["5", "1"],
      "JAKE GAITHER GOLF COURSE (CITY ID# 500)": ["2", "1"],
      "TALLAHASSEE CITY HALL (CITY ID# 100)": ["4", "1"],
      "SENIOR CITIZEN CENTER (CITY ID# 200)": ["6", "1"],
      "SOUTHWOOD GOLF COURSE (CITY ID# 600)": ["1", "1"],
      "HILAMAN GOLF COURSE (CITY ID# 400)": ["3", "1"]
    }

    async function getRequest(url){
      return fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'text/plain'
        }
      })
        .then(response =>  response.text())
          .then(text => {console.log("text: ", text);(
            new window.DOMParser()).parseFromString(text,"text/xml")})
            .then(xml => console.log("xml response: " + xml))
      
    }   

    function getRainData() {
        var startDate = document.getElementById("start").value ;
        var endDate = document.getElementById("end").value ;
        console.log(startDate + " to " + endDate);

        if (startDate === "" || endDate === "") {
          alert("Please enter a start and end date")
          return;
        }
        if (startDate > endDate) {
          alert("Please enter a start date that is before or equal to the end date")
          return;
        }

        for (var sensor in oneRainGetDict) {
          //`Fifteen is ${five + ten} and not ${2 * five + ten}.`)
          var queryTemplate = `&or_site_id=${oneRainGetDict[sensor][0]}&or_sensor_id=${oneRainGetDict[sensor][1]}&data_start=${startDate} 00:00&data_end=${endDate} 23:59&system_key=${oneRainSysKey}&tz=edt`
          var reqURL =  baseOneRainURL + queryTemplate;
          getRequest(reqURL);
          
          
        }

      }
</script>


